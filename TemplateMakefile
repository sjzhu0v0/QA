DIR_BASE=/lustre/alice/users/szhu/work/Analysis/PairFlow
PATH_INCLUDE=$(DIR_BASE)/include
FLAGS_INCLUDE=-I$(DIR_BASE)/include
FLAGS_ROOT=$(shell root-config --cflags --libs)
FLAGS_OPT=-I/lustre/alice/users/szhu/opt/include -I./ -L./opt -lMRootDict  -L/lustre/alice/users/szhu/opt/lib64   -Wl,-rpath,/lustre/alice/users/szhu/opt/lib64   -lyaml-cpp -lRooFitCore -lRooFit
FLAGS_MINUIT=-lMinuit

# Output directory for executables
DIR_EXE = exec

# List of source directories (add more as needed)
SRC_DIRS := macro/event_track process/event_track

# Collect all .cpp files from all source directories
SOURCES := $(foreach dir,$(SRC_DIRS),$(wildcard $(dir)/*.cpp))

# Create target paths that preserve directory structure in exe/ directory
# For example: macro/event_track/analysis.cpp -> exec/macro/event_track/analysis.exe
TARGETS := $(SOURCES:%.cpp=$(DIR_EXE)/%.exe)

# Debug output
$(info === Debug info ===)
$(info SOURCES = $(SOURCES))
$(info TARGETS = $(TARGETS))
$(info ================)

.PHONY: all clean install help

# Build all targets
all: $(TARGETS)
	@echo "All targets built: $(TARGETS)"

# Rule to create the exe directory and subdirectories (order-only prerequisite)
$(DIR_EXE):
	@mkdir -p $@

# Rule to create the directory structure for each target
$(foreach src,$(SOURCES),$(eval $(DIR_EXE)/$(dir $(src)): | $(DIR_EXE)))

# Rule to build each executable, preserving directory structure
$(DIR_EXE)/%.exe: %.cpp | $(DIR_EXE)
	@mkdir -p $(dir $@)
	@g++ $< -o $@ $(FLAGS_ROOT) $(FLAGS_INCLUDE) $(FLAGS_MINUIT) $(FLAGS_OPT)
	@echo "Compiled: $< -> $@"

# Clean all generated executables and the exe directory
clean:
	rm -rf $(DIR_EXE)

# Install rule to copy executables to a common bin directory
install: $(TARGETS)
	@mkdir -p bin
	@for target in $(TARGETS); do \
		dest_dir=$$(dirname $$target | sed 's|$(DIR_EXE)/||'); \
		mkdir -p bin/$$dest_dir; \
		cp $$target bin/$$dest_dir/; \
	done
	@echo "Installation complete. Executables copied to bin/"

# Help target to show available commands
help:
	@echo "Available targets:"
	@echo "  all     - Build all executables"
	@echo "  clean   - Remove all executables and build directory"
	@echo "  install - Install executables to bin/ directory"
	@echo "  help    - Show this help message"
	@echo ""
	@echo "Source directories: $(SRC_DIRS)"
	@echo "Source files: $(SOURCES)"
	@echo "Target executables: $(TARGETS)"